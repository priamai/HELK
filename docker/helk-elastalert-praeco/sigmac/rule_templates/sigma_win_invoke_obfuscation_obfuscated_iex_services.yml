alert:
- debug
description: "Detects all variations of obfuscated powershell IEX invocation code generated by Invoke-Obfuscation framework from the following code block \u2014 https://github.com/danielbohannon/Invoke-Obfuscation/blob/master/Out-ObfuscatedStringCommand.ps1#L873-L888"
filter:
- query:
    query_string:
      query: (event_id:"7045" AND (ImagePath:/\$PSHome\[\s*\d{1,3}\s*\]\s*\+\s*\$PSHome\[/ OR ImagePath:/\$ShellId\[\s*\d{1,3}\s*\]\s*\+\s*\$ShellId\[/ OR ImagePath:/\$env:Public\[\s*\d{1,3}\s*\]\s*\+\s*\$env:Public\[/ OR ImagePath:/\$env:ComSpec\[(\s*\d{1,3}\s*,){2}/ OR ImagePath:/\*mdr\*\W\s*\)\.Name/ OR ImagePath:/\$VerbosePreference\.ToString\(/ OR ImagePath:/\String\]\s*\$VerbosePreference/))
index: logs-endpoint-winevent-system-*
name: 51aa9387-1c53-4153-91cc-d73c59ae1ca9_0 Invoke-Obfuscation Obfuscated IEX Invocation 03
priority: 2
realert:
  minutes: 0
timestamp_field: etl_processed_time
type: any

alert:
- debug
description: "Detects all variations of obfuscated powershell IEX invocation code generated by Invoke-Obfuscation framework from the following code block \u2014 https://github.com/danielbohannon/Invoke-Obfuscation/blob/master/Out-ObfuscatedStringCommand.ps1#L873-L888"
filter:
- query:
    query_string:
      query: (event_id:"6" AND (ImagePath:/\$PSHome\[\s*\d{1,3}\s*\]\s*\+\s*\$PSHome\[/ OR ImagePath:/\$ShellId\[\s*\d{1,3}\s*\]\s*\+\s*\$ShellId\[/ OR ImagePath:/\$env:Public\[\s*\d{1,3}\s*\]\s*\+\s*\$env:Public\[/ OR ImagePath:/\$env:ComSpec\[(\s*\d{1,3}\s*,){2}/ OR ImagePath:/\*mdr\*\W\s*\)\.Name/ OR ImagePath:/\$VerbosePreference\.ToString\(/ OR ImagePath:/\String\]\s*\$VerbosePreference/))
index: logs-endpoint-winevent-sysmon-*
name: 51aa9387-1c53-4153-91cc-d73c59ae1ca9-2_0 Invoke-Obfuscation Obfuscated IEX Invocation 03
priority: 2
realert:
  minutes: 0
timestamp_field: etl_processed_time
type: any

alert:
- debug
description: "Detects all variations of obfuscated powershell IEX invocation code generated by Invoke-Obfuscation framework from the following code block \u2014 https://github.com/danielbohannon/Invoke-Obfuscation/blob/master/Out-ObfuscatedStringCommand.ps1#L873-L888"
filter:
- query:
    query_string:
      query: (event_id:"4697" AND (ImagePath:/\$PSHome\[\s*\d{1,3}\s*\]\s*\+\s*\$PSHome\[/ OR ImagePath:/\$ShellId\[\s*\d{1,3}\s*\]\s*\+\s*\$ShellId\[/ OR ImagePath:/\$env:Public\[\s*\d{1,3}\s*\]\s*\+\s*\$env:Public\[/ OR ImagePath:/\$env:ComSpec\[(\s*\d{1,3}\s*,){2}/ OR ImagePath:/\*mdr\*\W\s*\)\.Name/ OR ImagePath:/\$VerbosePreference\.ToString\(/ OR ImagePath:/\String\]\s*\$VerbosePreference/))
index: logs-endpoint-winevent-security-*
name: 51aa9387-1c53-4153-91cc-d73c59ae1ca9-3_0 Invoke-Obfuscation Obfuscated IEX Invocation 03
priority: 2
realert:
  minutes: 0
timestamp_field: etl_processed_time
type: any


